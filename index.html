<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8">
        <title>VR Drone Racing - Cidade Futurista</title>
        <meta name="description" content="Corrida de Drone em Cidade Futurista VR - Otimizado para Oculus">
        <!-- Evitar cache -->
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
        <meta http-equiv="Pragma" content="no-cache">
        <meta http-equiv="Expires" content="0">

        <!-- A-Frame Core (Local) -->
        <script src="libs/aframe.min.js"></script>

        <!-- A-Frame Extras (Local) -->
        <script src="libs/aframe-extras.min.js"></script>
        <script src="libs/aframe-environment-component.min.js"></script>

        <!-- Estilos CSS -->
        <link rel="stylesheet" type="text/css" href="css/style.css?v=1.0.2">
    </head>

    <body>
        <!-- Carregamento dos scripts do jogo - APENAS UMA VEZ -->
        <script src="js/utils.js?v=1.0.2"></script>
        <script src="js/game-manager.js?v=1.0.2"></script>
        <script src="js/drone-controller.js?v=1.0.5"></script>
        <script src="js/checkpoint-system.js?v=1.0.2"></script>
        <script src="js/urban-environment.js?v=1.0.3"></script>
        <script src="js/performance-monitor.js?v=1.0.2"></script>
        <script src="js/collision-system.js?v=1.0.2"></script>
        <script src="js/audio-system.js?v=1.0.4"></script>
        <script src="js/navigation-arrow.js?v=1.0.2"></script>

        <!-- √öNICA A-SCENE - Combinando atributos das duas anteriores -->
        <a-scene vr-mode-ui="enabled: true"
            webxr="requiredFeatures: local-floor; optionalFeatures: bounded-floor,hand-tracking"
            background="color: #87CEEB" fog="type: linear; color: #87CEEB; near: 50; far: 200"
            game-manager="totalCheckpoints: 3; timeLimit: 180"
            urban-environment="citySize: 60; buildingCount: 8; obstacleCount: 3; treeCount: 0; vrOptimized: true"
            performance-monitor="targetFPS: 72; minFPS: 60; autoOptimize: true; showStats: false"
            audio-system="masterVolume: 0.5; musicVolume: 0.2; sfxVolume: 0.6; ambientVolume: 0.1; enableAudio: true"
            collision-system="enabled: true; bounceForce: 0.5; showEffects: true; soundEnabled: true">

            <!-- Assets -->
            <a-assets>
                <!-- Modelos 3D -->
                <a-asset-item id="abbyroupaclara" src="assets/AbbyRoupaClara.glb"></a-asset-item>

                <!-- Mixins para reutiliza√ß√£o -->
                <a-mixin id="checkpoint" geometry="primitive: torus; radius: 4; radiusTubular: 0.5"
                    material="color: #00ff00; transparent: true; opacity: 0.8; metalness: 0.3; roughness: 0.4"
                    animation="property: rotation; to: 0 360 0; loop: true; dur: 6000">
                </a-mixin>

                <a-mixin id="building" material="color: #666; roughness: 0.8; metalness: 0.2"
                    physics-body="type: static; shape: box">
                </a-mixin>

                <a-mixin id="propeller" geometry="primitive: cylinder; radius: 0.4; height: 0.02"
                    material="color: #ff4444; transparent: true; opacity: 0.3">
                </a-mixin>
            </a-assets>

            <!-- Ambiente e Ilumina√ß√£o -->

            <!-- Ilumina√ß√£o -->
            <a-light type="ambient" color="#404040" intensity="0.5"></a-light>
            <a-light type="directional" position="20 40 20" color="#ffffff" intensity="1.2"
                shadow="cast: true; mapSize: 2048; cameraFar: 100; cameraNear: 0.1">
            </a-light>

            <!-- Luzes Futuristas Otimizadas -->
            <a-light type="point" position="20 10 -20" color="#00ffff" intensity="1.5" distance="25"></a-light>
            <a-light type="point" position="-20 12 -35" color="#ff00ff" intensity="1.2" distance="20"></a-light>

            <!-- Drone Principal -->
            <a-entity id="drone" position="0 0 0" drone-controller navigation-arrow
                physics-body="type: dynamic; mass: 2; linearDamping: 0.1; angularDamping: 0.1">

                <!-- Corpo do Drone Otimizado -->
                <a-entity id="drone-body" geometry="primitive: box; width: 1.0; height: 0.3; depth: 1.0"
                    material="color: #00aa00; metalness: 0.5; roughness: 0.5; emissive: #002200">

                    <!-- LEDs Simplificados -->
                    <a-entity geometry="primitive: sphere; radius: 0.03" material="color: #ff0000; emissive: #ff0000"
                        position="0.4 0.1 0.4"></a-entity>
                    <a-entity geometry="primitive: sphere; radius: 0.03" material="color: #00ff00; emissive: #00ff00"
                        position="-0.4 0.1 -0.4"></a-entity>
                </a-entity>

                <!-- Bra√ßos do Drone Simplificados -->
                <a-entity geometry="primitive: cylinder; radius: 0.05; height: 1.4"
                    material="color: #333; metalness: 0.3" position="0.6 0 0.6" rotation="0 45 0"></a-entity>
                <a-entity geometry="primitive: cylinder; radius: 0.05; height: 1.4"
                    material="color: #333; metalness: 0.3" position="-0.6 0 0.6" rotation="0 -45 0"></a-entity>
                <a-entity geometry="primitive: cylinder; radius: 0.05; height: 1.4"
                    material="color: #333; metalness: 0.3" position="0.6 0 -0.6" rotation="0 -45 0"></a-entity>
                <a-entity geometry="primitive: cylinder; radius: 0.05; height: 1.4"
                    material="color: #333; metalness: 0.3" position="-0.6 0 -0.6" rotation="0 45 0"></a-entity>

                <!-- H√©lices Otimizadas -->
                <a-entity id="prop1" mixin="propeller" position="0.8 0.2 0.8"
                    animation="property: rotation; to: 0 3600 0; loop: true; dur: 400"></a-entity>
                <a-entity id="prop2" mixin="propeller" position="-0.8 0.2 0.8"
                    animation="property: rotation; to: 0 -3600 0; loop: true; dur: 400"></a-entity>
                <a-entity id="prop3" mixin="propeller" position="0.8 0.2 -0.8"
                    animation="property: rotation; to: 0 -3600 0; loop: true; dur: 400"></a-entity>
                <a-entity id="prop4" mixin="propeller" position="-0.8 0.2 -0.8"
                    animation="property: rotation; to: 0 3600 0; loop: true; dur: 400"></a-entity>

                <!-- C√¢mera do Drone -->
                <a-camera id="drone-camera" position="0 -0.30 -0.5" rotation="-15 0 0" wasd-controls="enabled: false"
                    look-controls="enabled: true; pointerLockEnabled: false" vr-camera-sync>

                    <!-- HUD do jogador -->
                    <a-entity id="hud" position="0 0 -2">
                        <a-text id="timer" position="-1.5 1 0" value="Tempo: 00:00" color="#00ff00"
                            scale="0.8 0.8 0.8"></a-text>
                        <a-text id="checkpoint-counter" position="1.5 1 0" value="Checkpoint: 0/5" color="#00ff00"
                            scale="0.8 0.8 0.8"></a-text>
                        <a-text id="speed-indicator" position="0 -1.2 0" value="Velocidade: 0 km/h" color="#ffff00"
                            scale="0.6 0.6 0.6"></a-text>
                        <a-text id="flight-mode-indicator" position="0 1.5 0" value="üé¨ CINEMATOGR√ÅFICO" color="#ff8800"
                            scale="0.7 0.7 0.7"></a-text>
                    </a-entity>
                </a-camera>
            </a-entity>

            <!-- Percurso de Checkpoints Simplificado -->
            <a-entity mixin="checkpoint" position="15 8 -15" checkpoint="id: 1"></a-entity>
            <a-entity mixin="checkpoint" position="-20 12 -30" checkpoint="id: 2"></a-entity>
            <a-entity mixin="checkpoint" position="0 10 -45" checkpoint="id: 3"></a-entity>

            <!-- 3D do Ambiente -->

            <a-gltf-model src="#abbyroupaclara" position="-1.80562 0 -4.30211" scale="" rotation="" shadow=""
                gltf-model="assets/AbbyRoupaClara.glb"></a-gltf-model>

            <!-- Ch√£o base (ser√° complementado pelo ambiente urbano) -->
            <a-plane position="0 -0.1 0" rotation="-90 0 0" width="400" height="400" color="#2d5a27"
                shadow="receive: true"></a-plane>

            <!-- Controles VR Meta Quest 3 -->
            <a-entity id="leftHand" hand-controls="hand: left; handModelStyle: lowPoly; color: #ffcccc"
                oculus-touch-controls="hand: left; model: true" quest-controls="hand: left" vive-controls="hand: left"
                windows-motion-controls="hand: left" position="-0.5 1 -0.5">
            </a-entity>

            <a-entity id="rightHand" hand-controls="hand: right; handModelStyle: lowPoly; color: #ccffcc"
                oculus-touch-controls="hand: right; model: true" quest-controls="hand: right"
                vive-controls="hand: right" windows-motion-controls="hand: right" position="0.5 1 -0.5">
            </a-entity>

            <!-- Linha de chegada -->
            <a-entity geometry="primitive: box; width: 15; height: 0.3; depth: 1.5"
                material="color: #ff0000; transparent: true; opacity: 0.6" position="0 1 -50" finish-line></a-entity>
        </a-scene>

        <!-- Tela de carregamento -->
        <div id="loading">
            <h2>üöÅ Carregando Cidade Futurista VR...</h2>
            <p>ü•Ω Otimizado para Oculus Quest</p>
            <p>üé¨ Abby & Drone Adventure</p>
            <div class="progress-bar">
                <div class="progress"></div>
            </div>
        </div>

        <script>
            // Componente simples para sincronizar c√¢mera VR
            AFRAME.registerComponent('vr-camera-sync', {
                init: function () {
                    console.log('ü•Ω Sincroniza√ß√£o VR ativada');

                    this.browserState = {
                        position: this.el.getAttribute('position'),
                        rotation: this.el.getAttribute('rotation')
                    };

                    // Posi√ß√£o da c√¢mera para VR (embaixo do drone)
                    this.vrCameraPosition = { x: 0, y: -2.0, z: -0.5 }; // MUITO embaixo do drone
                    this.vrCameraRotation = { x: 10, y: 0, z: 0 }; // Olhando para baixo

                    // Capturar estado da c√¢mera antes de entrar no VR
                    this.el.sceneEl.addEventListener('enter-vr', () => {
                        console.log('üì± Entrando no VR - Posicionando c√¢mera embaixo do drone...');
                        this.positionCameraForVR();
                    });

                    // M√©todo para posicionar c√¢mera no VR
                    this.positionCameraForVR = () => {
                        // Aplicar posi√ß√£o espec√≠fica para VR (embaixo do drone) m√∫ltiplas vezes
                        for (let i = 0; i < 5; i++) {
                            setTimeout(() => {
                                this.el.setAttribute('position', this.vrCameraPosition);
                                this.el.setAttribute('rotation', this.vrCameraRotation);
                                console.log(`‚úÖ Tentativa ${i + 1}: C√¢mera VR posicionada embaixo do drone`);
                            }, 100 * (i + 1));
                        }
                    };

                    // Restaurar posi√ß√£o original ao sair do VR
                    this.el.sceneEl.addEventListener('exit-vr', () => {
                        console.log('üñ•Ô∏è Saindo do VR - Restaurando posi√ß√£o original...');
                        setTimeout(() => {
                            this.el.setAttribute('position', this.browserState.position);
                            this.el.setAttribute('rotation', this.browserState.rotation);
                        }, 100);
                    });

                    // Monitoramento cont√≠nuo
                    setInterval(() => {
                        if (this.el.sceneEl.is('vr-mode')) {
                            // Se estiver em VR, for√ßar posi√ß√£o embaixo do drone
                            const currentPos = this.el.getAttribute('position');
                            if (currentPos.y > -1.5) { // Se n√£o estiver embaixo suficiente
                                this.el.setAttribute('position', this.vrCameraPosition);
                                this.el.setAttribute('rotation', this.vrCameraRotation);
                                console.log('üîÑ For√ßando c√¢mera para baixo do drone');
                            }
                        } else {
                            // Se n√£o estiver em VR, atualizar estado do navegador
                            this.browserState.position = this.el.getAttribute('position');
                            this.browserState.rotation = this.el.getAttribute('rotation');
                        }
                    }, 200);
                }
            });

            // Inicializar o jogo quando a cena estiver carregada
            document.addEventListener('DOMContentLoaded', function () {
                console.log('üéÆ Inicializando o jogo...');

                const scene = document.querySelector('a-scene');
                scene.addEventListener('loaded', function () {
                    // Iniciar componentes principais ap√≥s 2 segundos
                    setTimeout(function () {
                        // Iniciar drone
                        const drone = document.querySelector('#drone');
                        if (drone && drone.components['drone-controller']) {
                            drone.components['drone-controller'].activateDrone();
                            console.log('‚úÖ Drone ativado com sucesso!');
                        } else {
                            console.error('‚ùå Erro ao ativar o drone!');
                        }

                        // Iniciar o jogo
                        const gameManager = document.querySelector('[game-manager]');
                        if (gameManager && gameManager.components['game-manager']) {
                            gameManager.components['game-manager'].startGame();
                            console.log('‚úÖ Jogo iniciado com sucesso!');
                        } else {
                            console.error('‚ùå Erro ao iniciar o jogo!');
                        }

                        // Esconder tela de carregamento
                        const loading = document.getElementById('loading');
                        if (loading) {
                            loading.style.display = 'none';
                        }

                        console.log('‚úÖ Jogo inicializado com sucesso!');
                    }, 2000);
                });
            });
        </script>
    </body>

</html>