<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8">
        <title>VR Drone Racing</title>
        <meta name="description" content="Corrida de Drone em VR">
        <!-- Evitar cache -->
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
        <meta http-equiv="Pragma" content="no-cache">
        <meta http-equiv="Expires" content="0">

        <!-- A-Frame Core (Local) -->
        <script src="libs/aframe.min.js"></script>

        <!-- A-Frame Extras (Local) -->
        <script src="libs/aframe-extras.min.js"></script>
        <script src="libs/aframe-environment-component.min.js"></script>

        <!-- Estilos CSS -->
        <link rel="stylesheet" type="text/css" href="css/style.css?v=1.0.2">
    </head>

    <body>
        <!-- Carregamento dos scripts do jogo - APENAS UMA VEZ -->
        <script src="js/utils.js?v=1.0.2"></script>
        <script src="js/game-manager.js?v=1.0.2"></script>
        <script src="js/drone-controller.js?v=1.0.5"></script>
        <script src="js/checkpoint-system.js?v=1.0.2"></script>
        <script src="js/urban-environment.js?v=1.0.3"></script>
        <script src="js/performance-monitor.js?v=1.0.2"></script>
        <script src="js/collision-system.js?v=1.0.2"></script>
        <script src="js/audio-system.js?v=1.0.4"></script>
        <script src="js/navigation-arrow.js?v=1.0.2"></script>

        <!-- ÚNICA A-SCENE - Combinando atributos das duas anteriores -->
        <a-scene vr-mode-ui="enabled: true"
            webxr="requiredFeatures: local-floor; optionalFeatures: bounded-floor,hand-tracking"
            background="color: #87CEEB" fog="type: linear; color: #87CEEB; near: 50; far: 200"
            game-manager="totalCheckpoints: 5; timeLimit: 120"
            urban-environment="citySize: 100; buildingCount: 15; obstacleCount: 8; treeCount: 5; vrOptimized: true"
            performance-monitor="targetFPS: 60; minFPS: 45; autoOptimize: true; showStats: true"
            audio-system="masterVolume: 0.7; musicVolume: 0.4; sfxVolume: 0.8; ambientVolume: 0.3; enableAudio: true"
            collision-system="enabled: true; bounceForce: 0.5; showEffects: true; soundEnabled: true">

            <!-- Assets -->
            <a-assets>
                <!-- Modelos 3D -->
                <a-asset-item id="predio-model" src="assets/Predio.glb"></a-asset-item>
                <a-asset-item id="quadra-model" src="assets/Predio em L.glb"></a-asset-item>
                <a-asset-item id="cyticyberpunk" src="assets/scene.gltf"></a-asset-item>
                <a-asset-item id="abbyroupaclara" src="assets/AbbyRoupaClara.glb"></a-asset-item>

                <!-- Mixins para reutilização -->
                <a-mixin id="checkpoint" geometry="primitive: torus; radius: 4; radiusTubular: 0.5"
                    material="color: #00ff00; transparent: true; opacity: 0.8; metalness: 0.3; roughness: 0.4"
                    animation="property: rotation; to: 0 360 0; loop: true; dur: 6000">
                </a-mixin>

                <a-mixin id="building" material="color: #666; roughness: 0.8; metalness: 0.2"
                    physics-body="type: static; shape: box">
                </a-mixin>

                <a-mixin id="propeller" geometry="primitive: cylinder; radius: 0.6; height: 0.03"
                    material="color: #ff4444; transparent: true; opacity: 0.4">
                </a-mixin>
            </a-assets>

            <!-- Ambiente e Iluminação -->

            <!-- Iluminação -->
            <a-light type="ambient" color="#404040" intensity="0.5"></a-light>
            <a-light type="directional" position="20 40 20" color="#ffffff" intensity="1.2"
                shadow="cast: true; mapSize: 2048; cameraFar: 100; cameraNear: 0.1">
            </a-light>

            <!-- Luzes Cyberpunk -->
            <a-light type="point" position="30 10 -30" color="#00ffff" intensity="2" distance="20"></a-light>
            <a-light type="point" position="45 12 -25" color="#ff00ff" intensity="1.8" distance="18"></a-light>
            <a-light type="point" position="25 8 -45" color="#ffff00" intensity="1.5" distance="15"></a-light>
            <a-light type="point" position="35 15 -40" color="#ff0080" intensity="2.2" distance="25"></a-light>

            <!-- Drone Principal -->
            <a-entity id="drone" position="0 0 0" drone-controller navigation-arrow
                physics-body="type: dynamic; mass: 2; linearDamping: 0.1; angularDamping: 0.1">

                <!-- Corpo do Drone -->
                <a-entity id="drone-body" geometry="primitive: box; width: 1.2; height: 0.4; depth: 1.2"
                    material="color: #00aa00; metalness: 0.8; roughness: 0.2; emissive: #002200">

                    <!-- Luzes LED do drone -->
                    <a-entity geometry="primitive: sphere; radius: 0.05" material="color: #ff0000; emissive: #ff0000"
                        position="0.5 0.1 0.5"></a-entity>
                    <a-entity geometry="primitive: sphere; radius: 0.05" material="color: #00ff00; emissive: #00ff00"
                        position="-0.5 0.1 0.5"></a-entity>
                    <a-entity geometry="primitive: sphere; radius: 0.05" material="color: #0000ff; emissive: #0000ff"
                        position="0.5 0.1 -0.5"></a-entity>
                    <a-entity geometry="primitive: sphere; radius: 0.05" material="color: #ffff00; emissive: #ffff00"
                        position="-0.5 0.1 -0.5"></a-entity>
                </a-entity>

                <!-- Braços do Drone -->
                <a-entity geometry="primitive: cylinder; radius: 0.08; height: 2" material="color: #333; metalness: 0.7"
                    position="0.8 0 0.8" rotation="0 45 0"></a-entity>
                <a-entity geometry="primitive: cylinder; radius: 0.08; height: 2" material="color: #333; metalness: 0.7"
                    position="-0.8 0 0.8" rotation="0 -45 0"></a-entity>
                <a-entity geometry="primitive: cylinder; radius: 0.08; height: 2" material="color: #333; metalness: 0.7"
                    position="0.8 0 -0.8" rotation="0 -45 0"></a-entity>
                <a-entity geometry="primitive: cylinder; radius: 0.08; height: 2" material="color: #333; metalness: 0.7"
                    position="-0.8 0 -0.8" rotation="0 45 0"></a-entity>

                <!-- Hélices -->
                <a-entity id="prop1" mixin="propeller" position="1.1 0.3 1.1"
                    animation="property: rotation; to: 0 3600 0; loop: true; dur: 300"></a-entity>
                <a-entity id="prop2" mixin="propeller" position="-1.1 0.3 1.1"
                    animation="property: rotation; to: 0 -3600 0; loop: true; dur: 300"></a-entity>
                <a-entity id="prop3" mixin="propeller" position="1.1 0.3 -1.1"
                    animation="property: rotation; to: 0 -3600 0; loop: true; dur: 300"></a-entity>
                <a-entity id="prop4" mixin="propeller" position="-1.1 0.3 -1.1"
                    animation="property: rotation; to: 0 3600 0; loop: true; dur: 300"></a-entity>

                <!-- Câmera do Drone -->
                <a-camera id="drone-camera" position="0 -0.30 -0.5" rotation="-15 0 0" wasd-controls="enabled: false"
                    look-controls="enabled: true; pointerLockEnabled: false" vr-camera-sync>

                    <!-- HUD do jogador -->
                    <a-entity id="hud" position="0 0 -2">
                        <a-text id="timer" position="-1.5 1 0" value="Tempo: 00:00" color="#00ff00"
                            scale="0.8 0.8 0.8"></a-text>
                        <a-text id="checkpoint-counter" position="1.5 1 0" value="Checkpoint: 0/5" color="#00ff00"
                            scale="0.8 0.8 0.8"></a-text>
                        <a-text id="speed-indicator" position="0 -1.2 0" value="Velocidade: 0 km/h" color="#ffff00"
                            scale="0.6 0.6 0.6"></a-text>
                        <a-text id="flight-mode-indicator" position="0 1.5 0" value="🎬 CINEMATOGRÁFICO" color="#ff8800"
                            scale="0.7 0.7 0.7"></a-text>
                    </a-entity>
                </a-camera>
            </a-entity>

            <!-- Percurso de Checkpoints -->
            <a-entity mixin="checkpoint" position="15 8 -15" checkpoint="id: 1"></a-entity>
            <a-entity mixin="checkpoint" position="-20 12 -30" checkpoint="id: 2"></a-entity>
            <a-entity mixin="checkpoint" position="25 6 -45" checkpoint="id: 3"></a-entity>
            <a-entity mixin="checkpoint" position="-15 18 -60" checkpoint="id: 4"></a-entity>
            <a-entity mixin="checkpoint" position="0 10 -75" checkpoint="id: 5"></a-entity>

            <!-- Modelos 3D do Ambiente -->
            <a-gltf-model src="#predio-model" position="0 0 -20" scale="1 1 1" rotation="0 0 0"
                shadow="cast: true; receive: true"></a-gltf-model>
            <a-gltf-model src="#quadra-model" position="0 0 -50" scale="1 1 1" rotation="0 0 0"
                shadow="cast: true; receive: true"></a-gltf-model>
            <!-- Cidade Cyberpunk - Modelo principal -->
            <a-gltf-model src="#cyticyberpunk" position="30 0 -30" scale="2 2 2" rotation="0 0 0"
                shadow="cast: true; receive: true"></a-gltf-model>

            <a-gltf-model src="#abbyroupaclara" position="-1.80562 0 -4.30211" scale="" rotation="" shadow=""
                gltf-model="assets/AbbyRoupaClara.glb"></a-gltf-model>

            <!-- Chão base (será complementado pelo ambiente urbano) -->
            <a-plane position="0 -0.1 0" rotation="-90 0 0" width="400" height="400" color="#2d5a27"
                shadow="receive: true"></a-plane>

            <!-- Controles VR Meta Quest 3 -->
            <a-entity id="leftHand" hand-controls="hand: left; handModelStyle: lowPoly; color: #ffcccc"
                oculus-touch-controls="hand: left; model: true" quest-controls="hand: left" vive-controls="hand: left"
                windows-motion-controls="hand: left" position="-0.5 1 -0.5">
            </a-entity>

            <a-entity id="rightHand" hand-controls="hand: right; handModelStyle: lowPoly; color: #ccffcc"
                oculus-touch-controls="hand: right; model: true" quest-controls="hand: right"
                vive-controls="hand: right" windows-motion-controls="hand: right" position="0.5 1 -0.5">
            </a-entity>

            <!-- Linha de chegada -->
            <a-entity geometry="primitive: box; width: 20; height: 0.5; depth: 2"
                material="color: #ff0000; transparent: true; opacity: 0.7" position="0 1 -90" finish-line></a-entity>
        </a-scene>

        <!-- Tela de carregamento -->
        <div id="loading">
            <h2>Carregando Drone Racing VR...</h2>
            <p>Prepare seu Meta Quest 3!</p>
            <div class="progress-bar">
                <div class="progress"></div>
            </div>
        </div>

        <script>
            // Componente simples para sincronizar câmera VR
            AFRAME.registerComponent('vr-camera-sync', {
                init: function () {
                    console.log('🥽 Sincronização VR ativada');

                    this.browserState = {
                        position: this.el.getAttribute('position'),
                        rotation: this.el.getAttribute('rotation')
                    };

                    // Posição da câmera para VR (embaixo do drone)
                    this.vrCameraPosition = { x: 0, y: -2.0, z: -0.5 }; // MUITO embaixo do drone
                    this.vrCameraRotation = { x: 10, y: 0, z: 0 }; // Olhando para baixo

                    // Capturar estado da câmera antes de entrar no VR
                    this.el.sceneEl.addEventListener('enter-vr', () => {
                        console.log('📱 Entrando no VR - Posicionando câmera embaixo do drone...');
                        this.positionCameraForVR();
                    });

                    // Método para posicionar câmera no VR
                    this.positionCameraForVR = () => {
                        // Aplicar posição específica para VR (embaixo do drone) múltiplas vezes
                        for (let i = 0; i < 5; i++) {
                            setTimeout(() => {
                                this.el.setAttribute('position', this.vrCameraPosition);
                                this.el.setAttribute('rotation', this.vrCameraRotation);
                                console.log(`✅ Tentativa ${i + 1}: Câmera VR posicionada embaixo do drone`);
                            }, 100 * (i + 1));
                        }
                    };

                    // Restaurar posição original ao sair do VR
                    this.el.sceneEl.addEventListener('exit-vr', () => {
                        console.log('🖥️ Saindo do VR - Restaurando posição original...');
                        setTimeout(() => {
                            this.el.setAttribute('position', this.browserState.position);
                            this.el.setAttribute('rotation', this.browserState.rotation);
                        }, 100);
                    });

                    // Monitoramento contínuo
                    setInterval(() => {
                        if (this.el.sceneEl.is('vr-mode')) {
                            // Se estiver em VR, forçar posição embaixo do drone
                            const currentPos = this.el.getAttribute('position');
                            if (currentPos.y > -1.5) { // Se não estiver embaixo suficiente
                                this.el.setAttribute('position', this.vrCameraPosition);
                                this.el.setAttribute('rotation', this.vrCameraRotation);
                                console.log('🔄 Forçando câmera para baixo do drone');
                            }
                        } else {
                            // Se não estiver em VR, atualizar estado do navegador
                            this.browserState.position = this.el.getAttribute('position');
                            this.browserState.rotation = this.el.getAttribute('rotation');
                        }
                    }, 200);
                }
            });

            // Inicializar o jogo quando a cena estiver carregada
            document.addEventListener('DOMContentLoaded', function () {
                console.log('🎮 Inicializando o jogo...');

                const scene = document.querySelector('a-scene');
                scene.addEventListener('loaded', function () {
                    // Iniciar componentes principais após 2 segundos
                    setTimeout(function () {
                        // Iniciar drone
                        const drone = document.querySelector('#drone');
                        if (drone && drone.components['drone-controller']) {
                            drone.components['drone-controller'].activateDrone();
                            console.log('✅ Drone ativado com sucesso!');
                        } else {
                            console.error('❌ Erro ao ativar o drone!');
                        }

                        // Iniciar o jogo
                        const gameManager = document.querySelector('[game-manager]');
                        if (gameManager && gameManager.components['game-manager']) {
                            gameManager.components['game-manager'].startGame();
                            console.log('✅ Jogo iniciado com sucesso!');
                        } else {
                            console.error('❌ Erro ao iniciar o jogo!');
                        }

                        // Esconder tela de carregamento
                        const loading = document.getElementById('loading');
                        if (loading) {
                            loading.style.display = 'none';
                        }

                        console.log('✅ Jogo inicializado com sucesso!');
                    }, 2000);
                });
            });
        </script>
    </body>

</html>