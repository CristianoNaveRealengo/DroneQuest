<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8">
        <title>VR Drone Racing - Cen√°rio Limpo</title>
        <meta name="description" content="Corrida de Drone VR - Cen√°rio Limpo Otimizado para Oculus">
        <!-- Evitar cache -->
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
        <meta http-equiv="Pragma" content="no-cache">
        <meta http-equiv="Expires" content="0">

        <!-- A-Frame Core (Local) -->
        <script src="libs/aframe.min.js"></script>

        <!-- A-Frame Extras (Local) -->
        <script src="libs/aframe-extras.min.js"></script>
        <script src="libs/aframe-environment-component.min.js"></script>

        <!-- Componente Sky 360 - Carregar DEPOIS do A-Frame -->
        <script>
            console.log('üîß Registrando componente sky-360-loader...');

            AFRAME.registerComponent('sky-360-loader', {
                schema: {
                    src: { type: 'string', default: 'assets/textures/bg-1.jpeg' }
                },

                init: function () {
                    console.log('üåÜ Sky 360 Loader INICIADO');
                    console.log('üìÇ Caminho:', this.data.src);
                    this.loadSkyTexture();
                },

                loadSkyTexture: function () {
                    const loader = new THREE.TextureLoader();
                    const sky = this.el;

                    console.log('üì• Carregando textura:', this.data.src);

                    // Aguardar o mesh estar pronto
                    setTimeout(() => {
                        loader.load(
                            this.data.src,
                            (texture) => {
                                console.log('‚úÖ SUCESSO! Textura carregada:', {
                                    width: texture.image.width,
                                    height: texture.image.height
                                });

                                // For√ßar aplica√ß√£o da textura
                                const mesh = sky.getObject3D('mesh');
                                if (mesh && mesh.material) {
                                    console.log('üîß Material antes:', mesh.material);

                                    // Aplicar textura
                                    mesh.material.map = texture;
                                    mesh.material.needsUpdate = true;

                                    // Garantir que est√° vis√≠vel
                                    mesh.material.side = THREE.BackSide;
                                    mesh.material.transparent = false;
                                    mesh.material.opacity = 1;

                                    console.log('üîß Material depois:', mesh.material);
                                    console.log('‚úÖ Sky 360 APLICADO!');
                                } else {
                                    console.error('‚ùå Mesh ou material n√£o encontrado!');
                                }
                            },
                            (xhr) => {
                                const percent = (xhr.loaded / xhr.total * 100).toFixed(0);
                                console.log(`üìä Progresso: ${percent}%`);
                            },
                            (error) => {
                                console.error('‚ùå ERRO ao carregar:', error);
                                console.error('‚ùå Caminho:', this.data.src);
                            }
                        );
                    }, 1000);
                }
            });

            console.log('‚úÖ Componente sky-360-loader registrado!');

            // Componente sky-parallax REMOVIDO para melhor performance
            // O parallax causava tremores e consumia recursos desnecess√°rios
            // Sky agora √© completamente est√°tico para m√°xima estabilidade e performance
        </script>

        <!-- Estilos CSS -->
        <link rel="stylesheet" type="text/css" href="css/style.css?v=1.0.2">

        <!-- Componente para Desabilitar Frustum Culling -->
        <script>
            AFRAME.registerComponent('frustum-culling-fix', {
                init: function () {
                    console.log('üîß Desabilitando frustum culling...');

                    this.el.addEventListener('model-loaded', () => {
                        console.log('‚úÖ Modelo carregado - aplicando fix de culling');

                        // Desabilitar frustum culling em todos os meshes
                        this.el.object3D.traverse((node) => {
                            if (node.isMesh) {
                                node.frustumCulled = false;
                                console.log('‚úÖ Frustum culling desabilitado para:', node.name);
                            }
                        });

                        // For√ßar renderiza√ß√£o sempre vis√≠vel
                        this.el.object3D.frustumCulled = false;

                        console.log('‚úÖ Fix de culling aplicado com sucesso!');
                    });
                }
            });
        </script>

        <!-- Script de Debug para Untitled.glb -->
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                console.log('üîç Verificando carregamento do Untitled.glb...');

                setTimeout(() => {
                    const untitledModel = document.querySelector('#untitled-model');

                    if (untitledModel) {
                        console.log('‚úÖ Elemento #untitled-model encontrado');
                        console.log('üìç Posi√ß√£o:', untitledModel.getAttribute('position'));
                        console.log('üìè Escala:', untitledModel.getAttribute('scale'));

                        untitledModel.addEventListener('model-loaded', () => {
                            console.log('‚úÖ Untitled.glb CARREGADO COM SUCESSO!');
                        });

                        untitledModel.addEventListener('model-error', (evt) => {
                            console.error('‚ùå ERRO ao carregar Untitled.glb:', evt.detail);
                        });
                    } else {
                        console.error('‚ùå Elemento #untitled-model N√ÉO encontrado!');
                    }
                }, 2000);
            });
        </script>
    </head>

    <body>
        <!-- Scripts Essenciais (Otimizado para Performance) -->
        <script src="js/drone-controller.js?v=1.0.5"></script>
        <script src="js/drone-rotation-fix.js?v=1.0.0"></script>
        <script src="js/checkpoint-system.js?v=1.0.2"></script>
        <script src="js/checkpoint-arrow.js?v=1.0.0"></script>
        <script src="js/model-collision.js?v=1.0.0"></script>

        <!-- Scripts Desativados para Performance -->
        <!-- <script src="js/utils.js?v=1.0.2"></script> -->
        <!-- <script src="js/game-manager.js?v=1.0.2"></script> -->
        <!-- <script src="js/urban-environment.js?v=1.0.3"></script> -->
        <!-- <script src="js/performance-monitor.js?v=1.0.2"></script> -->
        <!-- <script src="js/collision-system.js?v=1.0.2"></script> -->
        <!-- <script src="js/audio-system.js?v=1.0.4"></script> -->
        <!-- <script src="js/navigation-arrow.js?v=1.0.2"></script> -->
        <!-- <script src="js/hud-controller.js?v=1.0.0"></script> -->

        <!-- √öNICA A-SCENE - ULTRA OTIMIZADA PARA VR -->
        <!-- Cena Ultra Simplificada para M√°xima Performance -->
        <a-scene vr-mode-ui="enabled: true" webxr="requiredFeatures: local-floor"
            renderer="antialias: false; colorManagement: false; sortObjects: false; physicallyCorrectLights: false; powerPreference: high-performance; precision: mediump"
            stats>

            <!-- Assets -->
            <a-assets>
                <!-- Mixins para reutiliza√ß√£o -->
                <a-mixin id="checkpoint" geometry="primitive: torus; radius: 3; radiusTubular: 0.3"
                    material="color: #00ff00; transparent: true; opacity: 0.6; metalness: 0; roughness: 1; emissive: #00ff00; emissiveIntensity: 0.4"
                    animation="property: rotation; to: 0 360 0; loop: true; dur: 8000">
                </a-mixin>

                <!-- HUD Futur√≠stico
                <img id="hud-overlay" src="assets/hud-overlay.svg" crossorigin="anonymous"> -->

                <!-- HUD Limpo -->
                <img id="hud-overlay-limpo" src="assets/hud-01.svg" crossorigin="anonymous">

                <!-- Imagem 360 para Sky -->
                <img id="skyTexture" src="assets/textures/bg-1.jpeg">

                <!-- Textura do Ch√£o -->
                <img id="ground-texture" src="assets/textures/chao.jpg" crossorigin="anonymous">

            </a-assets>

            <!-- C√©u com Imagem (Ajustado e Alinhado) -->

            <!-- Ilumina√ß√£o Otimizada (2 luzes ao inv√©s de 3) -->
            <a-light type="ambient" color="#ffffff" intensity="1.0"></a-light>
            <a-light type="hemisphere" color="#ffffff" groundColor="#8A7050" intensity="0.7"></a-light>


            <!-- Drone Principal -->
            <a-entity id="drone" position="0 0 0" drone-controller
                drone-rotation-limiter="maxPitch: 35; maxRoll: 25; autoCorrect: true; correctionSpeed: 5.0; emergencyThreshold: 70"
                navigation-arrow
                drone-navigation-arrow="arrowColor: #00ff00; arrowSize: 1.2; offsetDistance: 3; offsetHeight: 1.5"
                physics-body="type: dynamic; mass: 2; linearDamping: 0.1; angularDamping: 0.1">

                <!-- Corpo do Drone Ultra-Simplificado -->
                <a-entity id="drone-body" geometry="primitive: box; width: 0.8; height: 0.2; depth: 0.8"
                    material="color: #00aa00; metalness: 0; roughness: 1; emissive: #001100; emissiveIntensity: 0.3">
                </a-entity>

                <!-- H√©lices Ultra-Simples -->
                <a-entity id="prop1" geometry="primitive: cylinder; radius: 0.25; height: 0.01"
                    material="color: #ff4444; transparent: true; opacity: 0.2" position="0.6 0.15 0.6"
                    animation="property: rotation; to: 0 1800 0; loop: true; dur: 600"></a-entity>
                <a-entity id="prop2" geometry="primitive: cylinder; radius: 0.25; height: 0.01"
                    material="color: #ff4444; transparent: true; opacity: 0.2" position="-0.6 0.15 0.6"
                    animation="property: rotation; to: 0 -1800 0; loop: true; dur: 600"></a-entity>
                <a-entity id="prop3" geometry="primitive: cylinder; radius: 0.25; height: 0.01"
                    material="color: #ff4444; transparent: true; opacity: 0.2" position="0.6 0.15 -0.6"
                    animation="property: rotation; to: 0 -1800 0; loop: true; dur: 600"></a-entity>
                <a-entity id="prop4" geometry="primitive: cylinder; radius: 0.25; height: 0.01"
                    material="color: #ff4444; transparent: true; opacity: 0.2" position="-0.6 0.15 -0.6"
                    animation="property: rotation; to: 0 1800 0; loop: true; dur: 600"></a-entity>

                <!-- C√¢mera do Drone -->
                <a-camera id="drone-camera" position="0 -0.30 -0.5" rotation="-15 0 0" wasd-controls="enabled: false"
                    look-controls="enabled: true; pointerLockEnabled: false" vr-camera-sync
                    camera="far: 5000; near: 0.1"
                    hud-controller="enabled: true; transparency: 1.0; hudWidth: 3.5; hudHeight: 2.5; hudDistance: 2.0; parallaxIntensity: 0.03; smoothingFactor: 0.1">
                </a-camera>
            </a-entity>

            <!-- Percurso de Checkpoints Simplificado -->
            <a-entity mixin="checkpoint" position="15 8 -15" checkpoint="id: 1"></a-entity>
            <a-entity mixin="checkpoint" position="-20 12 -30" checkpoint="id: 2"></a-entity>
            <a-entity mixin="checkpoint" position="0 10 -45" checkpoint="id: 3"></a-entity>

            <!--  ========== NPCs  ==========-->
            <!-- Modelo da Abby (COM FRUSTUM CULLING DESABILITADO) -->
            <a-gltf-model src="assets/npc/AbbyRoupaClara.glb" position="-1.806 -0.02341 -3.5" frustum-culling-fix>
            </a-gltf-model>

            <!-- Modelo Untitled ao lado da Abby (COM FRUSTUM CULLING DESABILITADO) -->
            <a-gltf-model id="untitled-model" src="assets/npc/AbbyHandRaising.glb" position="0.53202 0 -3.5" scale=""
                rotation="" animation-mixer="" visible="" frustum-culling-fix=""
                gltf-model="assets/npc/AbbyHandRaising.glb">
            </a-gltf-model>

            <a-gltf-model id="untitled-model" position="0.53202 0 -3.5" scale="" rotation="" animation-mixer=""
                visible="" frustum-culling-fix="" gltf-model="assets/npc/AbbyHandRaising.glb">
            </a-gltf-model>


            <!--  ========== Ilumina√ß√£o  ==========-->
            <!-- Luz para o rosto da Abby -->
            <a-light type="point" position="-1.806 1.5 -2.5" color="#ffffff" intensity="2.0" distance="5"></a-light>

            <!-- Luz para o Untitled -->
            <a-light type="point" position="-0.3 1.5 -2.5" color="#ffffff" intensity="2.0" distance="5"></a-light>

            <!-- ========== CEN√ÅRIO ========== -->

            <a-sky src="assets/cenario/sky-1.jpg" rotation="0 0 0" radius="5000">
            </a-sky>

            <!-- Ch√£o com Textura (Reduzido pela Metade) -->
            <a-plane id="ground-main" position="0 -1 0" rotation="-90 0 0" width="10000" height="10000"
                material="src: #ground-texture; color: #846338; repeat: 100 100; metalness: 0; roughness: 1; side: double; depthWrite: true; depthTest: true"
                shadow="receive: false" visible="true"></a-plane>

            <!-- Quadra com Colis√£o -->
            <a-gltf-model id="Quadra" position="-0.997 -2.20319 -0.264" scale="0.8 0.8 0.8"
                model-collision="type: box; width: 12; height: 0.5; depth: 18; offsetY: 0.25; visible: true; bounceForce: 0.8"
                gltf-model="assets/cenario/Quadra.glb">
            </a-gltf-model>

            <!-- Gol Esquerdo com Colis√£o -->
            <a-gltf-model id="gol-left" src="#gol-left" position="-1.25771 1.64154 12.14842" scale="0.8 0.8 0.8"
                rotation="0 -179.92077978477624 0"
                model-collision="type: box; width: 3; height: 2.5; depth: 1.5; offsetY: 1.25; visible: true; bounceForce: 0.8"
                gltf-model="assets/cenario/Gol.glb">
            </a-gltf-model>

            <!-- Gol Direito com Colis√£o -->
            <a-gltf-model id="gol-right" src="#gol-right" position="-0.55671 2.34324 -12.82934" scale="0.8 0.8 0.8"
                rotation="0 0.33861805692231656 0"
                model-collision="type: box; width: 3; height: 2.5; depth: 1.5; offsetY: 1.25; visible: true; bounceForce: 0.8"
                gltf-model="assets/cenario/Gol.glb">
            </a-gltf-model>

            <!-- Casa e Lojinha com Colis√£o -->
            <a-gltf-model id="casa-lojinha" src="#casa-lojinha" position="-25.72106 -0.28993 2.72127" scale="1 1 1"
                rotation="0 93.48551272693051 0"
                model-collision="type: box; width: 8; height: 4; depth: 6; offsetY: 2; visible: true; bounceForce: 0.8"
                gltf-model="assets/cenario/Casa-e-Lojinha.glb">
            </a-gltf-model>

            <a-gltf-model id="#Arvore" position="-25.72106 -0.28993 -6.82891" scale="" rotation="0 93.48551272693051 0"
                gltf-model="assets/cenario/Arvore.glb"></a-gltf-model>

            <a-gltf-model id="#Predio-em-L" position="-25.721 4.245 20.035" scale="4 4 4" rotation="0 93.486 0"
                model-collision="type: box; width: 8; height: 4; depth: 6; offsetY: 2; visible: true; bounceForce: 0.8"
                gltf-model="assets/cenario/Predio-em-L.glb"></a-gltf-model>

            <a-gltf-model id="#Escada" position="-52.746 -0.32993 -41.107" scale="0.5 0.5 0.405" rotation="0 93.486 0"
                gltf-model="assets/cenario/Escada.glb"></a-gltf-model>

            <!-- ========== ELEVA√á√ïES DO MORRO ========== -->

            <!-- Morro Principal - Reduzido pela Metade -->
            <a-cone position="15 0 -20" radius-bottom="17.5" radius-top="4" height="14"
                material="color: #7a6d5f; roughness: 1" segments-radial="6" segments-height="3"></a-cone>

            <!-- Morro Esquerda - Reduzido pela Metade -->
            <a-cone position="-12.5 0 -17.5" radius-bottom="11" radius-top="3" height="8"
                material="color: #7a6d5f; roughness: 1" segments-radial="4" segments-height="2"></a-cone>

            <!-- Morro Direita - Reduzido pela Metade -->
            <a-cone position="30 0 -15" radius-bottom="9" radius-top="4" height="4"
                material="color: #7a6d5f; roughness: 1" segments-radial="4" segments-height="2"></a-cone>

            <!-- Casas 2D removidas para melhor performance -->

            <!-- Limitador Invis√≠vel - Paredes do Sky -->
            <a-entity id="sky-boundary" boundary-limiter="radius: 5000"></a-entity>

            <!-- Controles VR Otimizados -->
            <a-entity id="leftHand" oculus-touch-controls="hand: left; model: false" quest-controls="hand: left"
                position="-0.5 1 -0.5">
            </a-entity>

            <a-entity id="rightHand" oculus-touch-controls="hand: right; model: false" quest-controls="hand: right"
                position="0.5 1 -0.5">
            </a-entity>

            <!-- Linha de chegada -->
            <a-entity geometry="primitive: box; width: 15; height: 0.3; depth: 1.5"
                material="color: #ff0000; transparent: true; opacity: 0.6" position="0 1 -50" finish-line></a-entity>
        </a-scene>

        <!-- Tela de carregamento -->
        <div id="loading">
            <h2>Carregando Cen√°rio VR...</h2>
            <h3>Prepare-se pra nova experiencia</h3>
            <small>Version - Alfa</small>
            <div class="progress-bar">
                <div class="progress"></div>
            </div>
        </div>

        <!-- Painel de Controles do HUD -->
        <div id="hud-help"
            style="position: fixed; top: 10px; right: 10px; background: rgba(0, 0, 0, 0.8); color: #ffffff; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 12px; z-index: 1000; border: 1px solid #ffffff; max-width: 320px;">
            <div style="font-weight: bold; margin-bottom: 10px; color: #ffffff;">üéØ HUD CONTROLLER CENTRALIZADO</div>
            <div style="margin-bottom: 5px;"><strong>H</strong> - Alternar HUD</div>
            <div style="margin-bottom: 5px;"><strong>U</strong> - Ajustar Transpar√™ncia</div>
            <div style="margin-bottom: 5px;"><strong>K</strong> - Recarregar HUD</div>
            <div style="color: #ffaa00; font-weight: bold; margin: 8px 0 5px 0;">üìè Dimens√µes:</div>
            <div style="margin-bottom: 5px;"><strong>+/-</strong> - Aumentar/Diminuir HUD</div>
            <div style="margin-bottom: 5px;"><strong>0</strong> - Reset completo</div>
            <div style="color: #ffaa00; font-weight: bold; margin: 8px 0 5px 0;">üìä Dados Exibidos:</div>
            <div style="margin-bottom: 3px;">‚Ä¢ Velocidade (KM/H)</div>
            <div style="margin-bottom: 3px;">‚Ä¢ Altitude (Metros)</div>
            <div style="margin-bottom: 3px;">‚Ä¢ Bateria (% com cor din√¢mica)</div>
            <div style="margin-bottom: 3px;">‚Ä¢ Coordenadas GPS</div>
            <div style="margin-bottom: 3px;">‚Ä¢ Dist√¢ncia para Objetivo</div>
            <div style="margin-bottom: 3px;">‚Ä¢ Modo de Voo</div>
            <div style="margin-bottom: 3px;">‚Ä¢ Tempo de Miss√£o</div>
            <div
                style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #ffffff; font-size: 10px; opacity: 0.8;">
                üéØ HUD totalmente transparente (sem fundo)<br>
                üìè Sistema centralizado para f√°cil manuten√ß√£o<br>
                üìç Paralaxe sutil baseado no movimento do drone<br>
                üõ∏ Apenas linhas brancas do hud-01.svg vis√≠veis
            </div>
        </div>

        <script>

            // Componente Limitador de Fronteira do Sky
            AFRAME.registerComponent('boundary-limiter', {
                schema: {
                    radius: { type: 'number', default: 9900 }
                },

                init: function () {
                    console.log('üöß Limitador de Fronteira ativado - Raio:', this.data.radius);
                    this.drone = null;
                },

                tick: function () {
                    if (!this.drone) {
                        this.drone = document.querySelector('#drone');
                        if (!this.drone) return;
                    }

                    const dronePos = this.drone.object3D.position;
                    const distance = Math.sqrt(dronePos.x * dronePos.x + dronePos.z * dronePos.z);

                    // Se o drone ultrapassar o limite, empurr√°-lo de volta
                    if (distance > this.data.radius) {
                        const angle = Math.atan2(dronePos.z, dronePos.x);
                        dronePos.x = Math.cos(angle) * this.data.radius;
                        dronePos.z = Math.sin(angle) * this.data.radius;

                        console.log('‚ö†Ô∏è Drone atingiu o limite! Reposicionando...');
                    }
                }
            });

            // Componente de Diagn√≥stico do Solo
            AFRAME.registerComponent('ground-diagnostics', {
                init: function () {
                    console.log('üîç Diagn√≥stico do Solo Iniciado');

                    setTimeout(() => {
                        const ground = document.querySelector('#ground-main');
                        if (ground) {
                            const material = ground.getAttribute('material');
                            const position = ground.getAttribute('position');
                            const visible = ground.getAttribute('visible');
                            const geometry = ground.getAttribute('geometry');

                            console.log('üìä Estado do Solo:', {
                                visible: visible,
                                position: position,
                                material: material,
                                geometry: geometry,
                                object3D: ground.object3D ? 'OK' : 'ERRO'
                            });

                            // For√ßar renderiza√ß√£o
                            if (ground.object3D) {
                                ground.object3D.visible = true;
                                ground.object3D.renderOrder = -1; // Renderizar primeiro
                                console.log('‚úÖ Solo for√ßado a renderizar');
                            }

                            // Monitorar mudan√ßas
                            setInterval(() => {
                                if (ground.object3D && !ground.object3D.visible) {
                                    console.warn('‚ö†Ô∏è Solo ficou invis√≠vel! Reativando...');
                                    ground.object3D.visible = true;
                                }
                            }, 1000);
                        } else {
                            console.error('‚ùå Solo n√£o encontrado!');
                        }
                    }, 2000);
                }
            });

            // Componente de Otimiza√ß√£o VR Avan√ßada
            AFRAME.registerComponent('vr-performance-optimizer', {
                init: function () {
                    console.log('üöÄ Otimizador VR ativado');

                    // Configura√ß√µes agressivas de performance
                    const renderer = this.el.renderer;
                    if (renderer) {
                        // Reduzir qualidade de renderiza√ß√£o para VR
                        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
                        renderer.shadowMap.enabled = false;
                        renderer.shadowMap.autoUpdate = false;

                        // Configura√ß√µes de performance
                        renderer.powerPreference = "high-performance";
                        renderer.antialias = false;
                        renderer.stencil = false;
                        renderer.depth = true;
                        renderer.logarithmicDepthBuffer = false;
                    }

                    // Otimiza√ß√µes espec√≠ficas para Quest
                    this.optimizeForQuest();

                    // Monitorar performance e ajustar dinamicamente
                    this.startPerformanceMonitoring();
                },

                optimizeForQuest: function () {
                    // Detectar se est√° rodando no Quest
                    const isQuest = navigator.userAgent.includes('Quest') ||
                        navigator.userAgent.includes('Oculus');

                    if (isQuest) {
                        console.log('ü•Ω Quest detectado - aplicando otimiza√ß√µes espec√≠ficas');

                        // Reduzir ainda mais a qualidade para Quest
                        const scene = this.el;
                        scene.setAttribute('renderer', {
                            antialias: false,
                            colorManagement: false,
                            sortObjects: false,
                            physicallyCorrectLights: false,
                            gammaFactor: 2.2,
                            highRefreshRate: true,
                            foveationLevel: 0, // Desativado para evitar desfoque
                            multiview: true
                        });

                        // Reduzir fog distance para Quest
                        scene.setAttribute('fog', {
                            type: 'linear',
                            color: '#87CEEB',
                            near: 500,
                            far: 1000
                        });
                    }
                },

                startPerformanceMonitoring: function () {
                    let frameCount = 0;
                    let lastTime = performance.now();
                    let lowFPSCount = 0;

                    const monitor = () => {
                        frameCount++;
                        const currentTime = performance.now();

                        if (currentTime - lastTime >= 1000) {
                            const fps = Math.round((frameCount * 1000) / (currentTime - lastTime));

                            // Se FPS baixo, aplicar otimiza√ß√µes emergenciais
                            if (fps < 60) {
                                lowFPSCount++;
                                if (lowFPSCount >= 3) {
                                    this.applyEmergencyOptimizations();
                                    lowFPSCount = 0;
                                }
                            } else {
                                lowFPSCount = 0;
                            }

                            frameCount = 0;
                            lastTime = currentTime;
                        }

                        requestAnimationFrame(monitor);
                    };

                    monitor();
                },

                applyEmergencyOptimizations: function () {
                    console.log('‚ö° Aplicando otimiza√ß√µes emergenciais');

                    // Cen√°rio j√° est√° limpo - sem elementos para ocultar
                    console.log('‚ö° Cen√°rio limpo - sem elementos adicionais para otimizar');

                    // Desabilitar anima√ß√µes n√£o essenciais
                    const props = document.querySelectorAll('[id^="prop"]');
                    props.forEach(prop => {
                        const anim = prop.getAttribute('animation');
                        if (anim) {
                            prop.setAttribute('animation', {
                                ...anim,
                                dur: 1000 // Anima√ß√£o mais lenta
                            });
                        }
                    });

                    // Reduzir fog distance no cen√°rio limpo
                    this.el.setAttribute('fog', {
                        type: 'linear',
                        color: '#87CEEB',
                        near: 500,
                        far: 1000
                    });
                }
            });

            // Componente simples para sincronizar c√¢mera VR
            AFRAME.registerComponent('vr-camera-sync', {
                init: function () {
                    console.log('ü•Ω Sincroniza√ß√£o VR ativada');

                    this.browserState = {
                        position: this.el.getAttribute('position'),
                        rotation: this.el.getAttribute('rotation')
                    };

                    // Posi√ß√£o da c√¢mera para VR (embaixo do drone)
                    this.vrCameraPosition = { x: 0, y: -2.0, z: -0.5 }; // MUITO embaixo do drone
                    this.vrCameraRotation = { x: 10, y: 0, z: 0 }; // Olhando para baixo

                    // Capturar estado da c√¢mera antes de entrar no VR
                    this.el.sceneEl.addEventListener('enter-vr', () => {
                        console.log('üì± Entrando no VR - Posicionando c√¢mera embaixo do drone...');
                        this.positionCameraForVR();
                    });

                    // M√©todo para posicionar c√¢mera no VR
                    this.positionCameraForVR = () => {
                        // Aplicar posi√ß√£o espec√≠fica para VR (embaixo do drone) m√∫ltiplas vezes
                        for (let i = 0; i < 5; i++) {
                            setTimeout(() => {
                                this.el.setAttribute('position', this.vrCameraPosition);
                                this.el.setAttribute('rotation', this.vrCameraRotation);
                                console.log(`‚úÖ Tentativa ${i + 1}: C√¢mera VR posicionada embaixo do drone`);
                            }, 100 * (i + 1));
                        }
                    };

                    // Restaurar posi√ß√£o original ao sair do VR
                    this.el.sceneEl.addEventListener('exit-vr', () => {
                        console.log('üñ•Ô∏è Saindo do VR - Restaurando posi√ß√£o original...');
                        setTimeout(() => {
                            this.el.setAttribute('position', this.browserState.position);
                            this.el.setAttribute('rotation', this.browserState.rotation);
                        }, 100);
                    });

                    // Monitoramento cont√≠nuo
                    setInterval(() => {
                        if (this.el.sceneEl.is('vr-mode')) {
                            // Se estiver em VR, for√ßar posi√ß√£o embaixo do drone
                            const currentPos = this.el.getAttribute('position');
                            if (currentPos.y > -1.5) { // Se n√£o estiver embaixo suficiente
                                this.el.setAttribute('position', this.vrCameraPosition);
                                this.el.setAttribute('rotation', this.vrCameraRotation);
                                console.log('üîÑ For√ßando c√¢mera para baixo do drone');
                            }
                        } else {
                            // Se n√£o estiver em VR, atualizar estado do navegador
                            this.browserState.position = this.el.getAttribute('position');
                            this.browserState.rotation = this.el.getAttribute('rotation');
                        }
                    }, 200);
                }
            });

            // Inicializar o jogo quando a cena estiver carregada
            document.addEventListener('DOMContentLoaded', function () {
                console.log('üéÆ Jogo carregado - Drone pronto!');

                const scene = document.querySelector('a-scene');
                scene.addEventListener('loaded', function () {
                    console.log('‚úÖ Cena carregada com sucesso!');

                    // Iniciar o jogo ap√≥s 1 segundo
                    setTimeout(function () {
                        const gameManager = document.querySelector('[game-manager]');
                        if (gameManager && gameManager.components['game-manager']) {
                            gameManager.components['game-manager'].startGame();
                            console.log('‚úÖ Jogo iniciado!');
                        } else {
                            console.error('‚ùå Erro ao iniciar o jogo!');
                        }

                        // Esconder tela de carregamento
                        const loading = document.getElementById('loading');
                        if (loading) {
                            loading.style.display = 'none';
                        }

                        console.log('‚úÖ Jogo inicializado com sucesso!');

                        // Verificar sky 360
                        const mainSky = document.querySelector('#main-sky');
                        console.log('üåÜ Sky 360 bg-6 carregado:', mainSky?.getAttribute('src'));

                        // Verificar se o HUD Controller foi carregado
                        setTimeout(() => {
                            const camera = document.querySelector('#drone-camera');
                            const hudComponent = camera?.components?.['hud-controller'];

                            if (hudComponent) {
                                console.log('üéØ HUD Controller carregado com sucesso!');
                                console.log('üìä Configura√ß√µes do HUD:', {
                                    width: hudComponent.data.hudWidth,
                                    height: hudComponent.data.hudHeight,
                                    transparency: hudComponent.data.transparency,
                                    distance: hudComponent.data.hudDistance
                                });
                            } else {
                                console.warn('‚ö†Ô∏è HUD Controller n√£o foi carregado!');
                            }
                        }, 1000);

                        // Ocultar painel de ajuda do HUD ap√≥s 8 segundos
                        setTimeout(() => {
                            const hudHelp = document.getElementById('hud-help');
                            if (hudHelp) {
                                hudHelp.style.opacity = '0.3';
                                hudHelp.style.transition = 'opacity 1s ease-out';
                            }
                        }, 8000);

                        // Ocultar completamente ap√≥s 15 segundos
                        setTimeout(() => {
                            const hudHelp = document.getElementById('hud-help');
                            if (hudHelp) {
                                hudHelp.style.display = 'none';
                            }
                        }, 15000);
                    }, 2000);
                });
            });
        </script>
    </body>

</html>