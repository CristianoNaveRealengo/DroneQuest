<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8">
        <title>VR Drone Racing - Cenário Limpo</title>
        <meta name="description" content="Corrida de Drone VR - Cenário Limpo Otimizado para Oculus">
        <!-- Evitar cache -->
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
        <meta http-equiv="Pragma" content="no-cache">
        <meta http-equiv="Expires" content="0">

        <!-- A-Frame Core (Local) -->
        <script src="libs/aframe.min.js"></script>

        <!-- A-Frame Extras (Local) -->
        <script src="libs/aframe-extras.min.js"></script>
        <script src="libs/aframe-environment-component.min.js"></script>

        <!-- Estilos CSS -->
        <link rel="stylesheet" type="text/css" href="css/style.css?v=1.0.2">
    </head>

    <body>
        <!-- Carregamento dos scripts do jogo - APENAS UMA VEZ -->
        <script src="js/utils.js?v=1.0.2"></script>
        <script src="js/game-manager.js?v=1.0.2"></script>
        <script src="js/drone-controller.js?v=1.0.5"></script>
        <script src="js/checkpoint-system.js?v=1.0.2"></script>
        <script src="js/urban-environment.js?v=1.0.3"></script>
        <script src="js/performance-monitor.js?v=1.0.2"></script>
        <script src="js/collision-system.js?v=1.0.2"></script>
        <script src="js/audio-system.js?v=1.0.4"></script>
        <script src="js/navigation-arrow.js?v=1.0.2"></script>
        <script src="js/hud-controller.js?v=1.0.0"></script>

        <!-- ÚNICA A-SCENE - ULTRA OTIMIZADA PARA VR -->
        <a-scene vr-mode-ui="enabled: true" webxr="requiredFeatures: local-floor; optionalFeatures: bounded-floor"
            background="color: #87CEEB" fog="type: linear; color: #87CEEB; near: 50; far: 200"
            renderer="antialias: false; colorManagement: false; sortObjects: false; physicallyCorrectLights: false; gammaFactor: 2.2; highRefreshRate: true; foveationLevel: 1"
            game-manager="totalCheckpoints: 3; timeLimit: 180"
            urban-environment="citySize: 30; buildingCount: 0; obstacleCount: 0; treeCount: 0; vrOptimized: true; ultraLowPoly: true"
            performance-monitor="targetFPS: 90; minFPS: 72; autoOptimize: true; showStats: false; aggressiveOptimization: true"
            audio-system="masterVolume: 0.4; musicVolume: 0.1; sfxVolume: 0.5; ambientVolume: 0.05; enableAudio: true"
            collision-system="enabled: true; bounceForce: 0.5; showEffects: false; soundEnabled: false" hud-controls
            vr-performance-optimizer>

            <!-- Assets -->
            <a-assets>
                <!-- Mixins para reutilização -->
                <a-mixin id="checkpoint" geometry="primitive: torus; radius: 3; radiusTubular: 0.3"
                    material="color: #00ff00; transparent: true; opacity: 0.6; metalness: 0; roughness: 1; emissive: #00ff00; emissiveIntensity: 0.4"
                    animation="property: rotation; to: 0 360 0; loop: true; dur: 8000">
                </a-mixin>

                <!-- HUD Futurístico
                <img id="hud-overlay" src="assets/hud-overlay.svg" crossorigin="anonymous"> -->

                <!-- HUD Limpo -->
                <img id="hud-overlay-limpo" src="assets/hud-01.svg" crossorigin="anonymous">

            </a-assets>

            <!-- Iluminação Neutra Otimizada -->
            <a-light type="ambient" color="#404040" intensity="0.4"></a-light>
            <a-light type="directional" position="1 1 1" color="#ffffff" intensity="0.6"></a-light>


            <!-- Drone Principal -->
            <a-entity id="drone" position="0 0 0" drone-controller navigation-arrow
                physics-body="type: dynamic; mass: 2; linearDamping: 0.1; angularDamping: 0.1">

                <!-- Corpo do Drone Ultra-Simplificado -->
                <a-entity id="drone-body" geometry="primitive: box; width: 0.8; height: 0.2; depth: 0.8"
                    material="color: #00aa00; metalness: 0; roughness: 1; emissive: #001100; emissiveIntensity: 0.3">

                    <!-- Apenas 1 LED Central -->
                    <a-entity geometry="primitive: sphere; radius: 0.02"
                        material="color: #00ff00; emissive: #00ff00; emissiveIntensity: 0.8"
                        position="0 0.12 0"></a-entity>
                </a-entity>


                <!-- Hélices Ultra-Simples -->
                <a-entity id="prop1" geometry="primitive: cylinder; radius: 0.25; height: 0.01"
                    material="color: #ff4444; transparent: true; opacity: 0.2" position="0.6 0.15 0.6"
                    animation="property: rotation; to: 0 1800 0; loop: true; dur: 600"></a-entity>
                <a-entity id="prop2" geometry="primitive: cylinder; radius: 0.25; height: 0.01"
                    material="color: #ff4444; transparent: true; opacity: 0.2" position="-0.6 0.15 0.6"
                    animation="property: rotation; to: 0 -1800 0; loop: true; dur: 600"></a-entity>
                <a-entity id="prop3" geometry="primitive: cylinder; radius: 0.25; height: 0.01"
                    material="color: #ff4444; transparent: true; opacity: 0.2" position="0.6 0.15 -0.6"
                    animation="property: rotation; to: 0 -1800 0; loop: true; dur: 600"></a-entity>
                <a-entity id="prop4" geometry="primitive: cylinder; radius: 0.25; height: 0.01"
                    material="color: #ff4444; transparent: true; opacity: 0.2" position="-0.6 0.15 -0.6"
                    animation="property: rotation; to: 0 1800 0; loop: true; dur: 600"></a-entity>

                <!-- Câmera do Drone -->
                <a-camera id="drone-camera" position="0 -0.30 -0.5" rotation="-15 0 0" wasd-controls="enabled: false"
                    look-controls="enabled: true; pointerLockEnabled: false" vr-camera-sync
                    hud-controller="enabled: true; transparency: 1.0; hudWidth: 3.5; hudHeight: 2.5; hudDistance: 2.0; parallaxIntensity: 0.03; smoothingFactor: 0.1">

                    <!-- HUD Transparente com paralaxe sutil será criado automaticamente pelo componente -->
                </a-camera>
            </a-entity>

            <!-- Percurso de Checkpoints Simplificado -->
            <a-entity mixin="checkpoint" position="15 8 -15" checkpoint="id: 1"></a-entity>
            <a-entity mixin="checkpoint" position="-20 12 -30" checkpoint="id: 2"></a-entity>
            <a-entity mixin="checkpoint" position="0 10 -45" checkpoint="id: 3"></a-entity>


            <!-- Modelo da Abby -->
            <a-gltf-model src="assets/npc/AbbyRoupaClara.glb" position="-1.806 -0.07805 -3.5"></a-gltf-model>

            <!-- Iluminação otimizada para o rosto da Abby -->
            <!-- Luz principal frontal para o rosto -->
            <a-light type="point" position="-1.806 1.2 -2.8" color="#ffeeaa" intensity="3.2" distance="8"></a-light>

            <!-- Luz de preenchimento lateral (ajustada) -->
            <a-light type="point" position="-0.80562 1.5 -4.30211" color="#ffeeaa" intensity="1.8"
                distance="4"></a-light>

            <!-- Luz de contorno sutil -->
            <a-light type="point" position="-2.8 1.0 -3.5" color="#ffffff" intensity="1.5" distance="6"></a-light>

            <a-gltf-model src="#quadra" position="-0.99733 6.94942 -0.26371" í="" gltf-model="assets/Quadra.glb"
                scale="0.8 0.8 0.8"></a-gltf-model>

            <!-- Chão Otimizado - Tom Amarelo/Dourado (sem textura) -->
            <a-plane position="0 -0.1 0" rotation="-90 0 0" width="500" height="500"
                material="color: #C9A961; metalness: 0; roughness: 0.95; flatShading: true"
                shadow="receive: false"></a-plane>

            <!-- Patches com Variações de Tom Amarelo/Dourado -->
            <a-plane position="20 -0.09 25" rotation="-90 0 0" width="80" height="80"
                material="color: #D4B76E; metalness: 0; roughness: 0.92; flatShading: true"
                shadow="receive: false"></a-plane>

            <a-plane position="-35 -0.09 -15" rotation="-90 0 0" width="70" height="70"
                material="color: #B89A54; metalness: 0; roughness: 0.97; flatShading: true"
                shadow="receive: false"></a-plane>

            <a-plane position="45 -0.09 -40" rotation="-90 0 0" width="90" height="90"
                material="color: #DCC57A; metalness: 0; roughness: 0.94; flatShading: true"
                shadow="receive: false"></a-plane>

            <a-plane position="-50 -0.09 35" rotation="-90 0 0" width="75" height="75"
                material="color: #AE9350; metalness: 0; roughness: 0.96; flatShading: true"
                shadow="receive: false"></a-plane>

            <a-plane position="15 -0.09 -60" rotation="-90 0 0" width="85" height="85"
                material="color: #E0CA82; metalness: 0; roughness: 0.93; flatShading: true"
                shadow="receive: false"></a-plane>

            <a-plane position="-25 -0.09 -50" rotation="-90 0 0" width="65" height="65"
                material="color: #C2A85C; metalness: 0; roughness: 0.91; flatShading: true"
                shadow="receive: false"></a-plane>

            <!-- Controles VR Otimizados -->
            <a-entity id="leftHand" oculus-touch-controls="hand: left; model: false" quest-controls="hand: left"
                position="-0.5 1 -0.5">
            </a-entity>

            <a-entity id="rightHand" oculus-touch-controls="hand: right; model: false" quest-controls="hand: right"
                position="0.5 1 -0.5">
            </a-entity>

            <!-- Linha de chegada -->
            <a-entity geometry="primitive: box; width: 15; height: 0.3; depth: 1.5"
                material="color: #ff0000; transparent: true; opacity: 0.6" position="0 1 -50" finish-line></a-entity>
        </a-scene>

        <!-- Tela de carregamento -->
        <div id="loading">
            <h2>Carregando Cenário Limpo VR...</h2>
            <p>Otimizado para Oculus Quest</p>
            <p>Abby & Drone Adventure</p>
            <div class="progress-bar">
                <div class="progress"></div>
            </div>
        </div>

        <!-- Painel de Controles do HUD -->
        <div id="hud-help"
            style="position: fixed; top: 10px; right: 10px; background: rgba(0, 0, 0, 0.8); color: #ffffff; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 12px; z-index: 1000; border: 1px solid #ffffff; max-width: 320px;">
            <div style="font-weight: bold; margin-bottom: 10px; color: #ffffff;">🎯 HUD CONTROLLER CENTRALIZADO</div>
            <div style="margin-bottom: 5px;"><strong>H</strong> - Alternar HUD</div>
            <div style="margin-bottom: 5px;"><strong>U</strong> - Ajustar Transparência</div>
            <div style="margin-bottom: 5px;"><strong>K</strong> - Recarregar HUD</div>
            <div style="color: #ffaa00; font-weight: bold; margin: 8px 0 5px 0;">📏 Dimensões:</div>
            <div style="margin-bottom: 5px;"><strong>+/-</strong> - Aumentar/Diminuir HUD</div>
            <div style="margin-bottom: 5px;"><strong>0</strong> - Reset completo</div>
            <div style="color: #ffaa00; font-weight: bold; margin: 8px 0 5px 0;">📊 Dados Exibidos:</div>
            <div style="margin-bottom: 3px;">• Velocidade (KM/H)</div>
            <div style="margin-bottom: 3px;">• Altitude (Metros)</div>
            <div style="margin-bottom: 3px;">• Bateria (% com cor dinâmica)</div>
            <div style="margin-bottom: 3px;">• Coordenadas GPS</div>
            <div style="margin-bottom: 3px;">• Distância para Objetivo</div>
            <div style="margin-bottom: 3px;">• Modo de Voo</div>
            <div style="margin-bottom: 3px;">• Tempo de Missão</div>
            <div
                style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #ffffff; font-size: 10px; opacity: 0.8;">
                🎯 HUD totalmente transparente (sem fundo)<br>
                📏 Sistema centralizado para fácil manutenção<br>
                📍 Paralaxe sutil baseado no movimento do drone<br>
                🛸 Apenas linhas brancas do hud-01.svg visíveis
            </div>
        </div>

        <script>
            // Componente de Otimização VR Avançada
            AFRAME.registerComponent('vr-performance-optimizer', {
                init: function () {
                    console.log('🚀 Otimizador VR ativado');

                    // Configurações agressivas de performance
                    const renderer = this.el.renderer;
                    if (renderer) {
                        // Reduzir qualidade de renderização para VR
                        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
                        renderer.shadowMap.enabled = false;
                        renderer.shadowMap.autoUpdate = false;

                        // Configurações de performance
                        renderer.powerPreference = "high-performance";
                        renderer.antialias = false;
                        renderer.stencil = false;
                        renderer.depth = true;
                        renderer.logarithmicDepthBuffer = false;
                    }

                    // Otimizações específicas para Quest
                    this.optimizeForQuest();

                    // Monitorar performance e ajustar dinamicamente
                    this.startPerformanceMonitoring();
                },

                optimizeForQuest: function () {
                    // Detectar se está rodando no Quest
                    const isQuest = navigator.userAgent.includes('Quest') ||
                        navigator.userAgent.includes('Oculus');

                    if (isQuest) {
                        console.log('🥽 Quest detectado - aplicando otimizações específicas');

                        // Reduzir ainda mais a qualidade para Quest
                        const scene = this.el;
                        scene.setAttribute('renderer', {
                            antialias: false,
                            colorManagement: false,
                            sortObjects: false,
                            physicallyCorrectLights: false,
                            gammaFactor: 2.2,
                            highRefreshRate: true,
                            foveationLevel: 2, // Máximo foveation
                            multiview: true
                        });

                        // Reduzir fog distance para Quest
                        scene.setAttribute('fog', {
                            type: 'linear',
                            color: '#87CEEB',
                            near: 30,
                            far: 120
                        });
                    }
                },

                startPerformanceMonitoring: function () {
                    let frameCount = 0;
                    let lastTime = performance.now();
                    let lowFPSCount = 0;

                    const monitor = () => {
                        frameCount++;
                        const currentTime = performance.now();

                        if (currentTime - lastTime >= 1000) {
                            const fps = Math.round((frameCount * 1000) / (currentTime - lastTime));

                            // Se FPS baixo, aplicar otimizações emergenciais
                            if (fps < 60) {
                                lowFPSCount++;
                                if (lowFPSCount >= 3) {
                                    this.applyEmergencyOptimizations();
                                    lowFPSCount = 0;
                                }
                            } else {
                                lowFPSCount = 0;
                            }

                            frameCount = 0;
                            lastTime = currentTime;
                        }

                        requestAnimationFrame(monitor);
                    };

                    monitor();
                },

                applyEmergencyOptimizations: function () {
                    console.log('⚡ Aplicando otimizações emergenciais');

                    // Cenário já está limpo - sem elementos para ocultar
                    console.log('⚡ Cenário limpo - sem elementos adicionais para otimizar');

                    // Desabilitar animações não essenciais
                    const props = document.querySelectorAll('[id^="prop"]');
                    props.forEach(prop => {
                        const anim = prop.getAttribute('animation');
                        if (anim) {
                            prop.setAttribute('animation', {
                                ...anim,
                                dur: 1000 // Animação mais lenta
                            });
                        }
                    });

                    // Reduzir fog distance no cenário limpo
                    this.el.setAttribute('fog', {
                        type: 'linear',
                        color: '#87CEEB',
                        near: 25,
                        far: 100
                    });
                }
            });

            // Componente simples para sincronizar câmera VR
            AFRAME.registerComponent('vr-camera-sync', {
                init: function () {
                    console.log('🥽 Sincronização VR ativada');

                    this.browserState = {
                        position: this.el.getAttribute('position'),
                        rotation: this.el.getAttribute('rotation')
                    };

                    // Posição da câmera para VR (embaixo do drone)
                    this.vrCameraPosition = { x: 0, y: -2.0, z: -0.5 }; // MUITO embaixo do drone
                    this.vrCameraRotation = { x: 10, y: 0, z: 0 }; // Olhando para baixo

                    // Capturar estado da câmera antes de entrar no VR
                    this.el.sceneEl.addEventListener('enter-vr', () => {
                        console.log('📱 Entrando no VR - Posicionando câmera embaixo do drone...');
                        this.positionCameraForVR();
                    });

                    // Método para posicionar câmera no VR
                    this.positionCameraForVR = () => {
                        // Aplicar posição específica para VR (embaixo do drone) múltiplas vezes
                        for (let i = 0; i < 5; i++) {
                            setTimeout(() => {
                                this.el.setAttribute('position', this.vrCameraPosition);
                                this.el.setAttribute('rotation', this.vrCameraRotation);
                                console.log(`✅ Tentativa ${i + 1}: Câmera VR posicionada embaixo do drone`);
                            }, 100 * (i + 1));
                        }
                    };

                    // Restaurar posição original ao sair do VR
                    this.el.sceneEl.addEventListener('exit-vr', () => {
                        console.log('🖥️ Saindo do VR - Restaurando posição original...');
                        setTimeout(() => {
                            this.el.setAttribute('position', this.browserState.position);
                            this.el.setAttribute('rotation', this.browserState.rotation);
                        }, 100);
                    });

                    // Monitoramento contínuo
                    setInterval(() => {
                        if (this.el.sceneEl.is('vr-mode')) {
                            // Se estiver em VR, forçar posição embaixo do drone
                            const currentPos = this.el.getAttribute('position');
                            if (currentPos.y > -1.5) { // Se não estiver embaixo suficiente
                                this.el.setAttribute('position', this.vrCameraPosition);
                                this.el.setAttribute('rotation', this.vrCameraRotation);
                                console.log('🔄 Forçando câmera para baixo do drone');
                            }
                        } else {
                            // Se não estiver em VR, atualizar estado do navegador
                            this.browserState.position = this.el.getAttribute('position');
                            this.browserState.rotation = this.el.getAttribute('rotation');
                        }
                    }, 200);
                }
            });

            // Inicializar o jogo quando a cena estiver carregada
            document.addEventListener('DOMContentLoaded', function () {
                console.log('🎮 Inicializando o jogo...');

                const scene = document.querySelector('a-scene');
                scene.addEventListener('loaded', function () {
                    // Iniciar componentes principais após 2 segundos
                    setTimeout(function () {
                        // Iniciar drone
                        const drone = document.querySelector('#drone');
                        if (drone && drone.components['drone-controller']) {
                            drone.components['drone-controller'].activateDrone();
                            console.log('✅ Drone ativado com sucesso!');
                        } else {
                            console.error('❌ Erro ao ativar o drone!');
                        }

                        // Iniciar o jogo
                        const gameManager = document.querySelector('[game-manager]');
                        if (gameManager && gameManager.components['game-manager']) {
                            gameManager.components['game-manager'].startGame();
                            console.log('✅ Jogo iniciado com sucesso!');
                        } else {
                            console.error('❌ Erro ao iniciar o jogo!');
                        }

                        // Esconder tela de carregamento
                        const loading = document.getElementById('loading');
                        if (loading) {
                            loading.style.display = 'none';
                        }

                        console.log('✅ Jogo inicializado com sucesso!');

                        // Verificar se o HUD Controller foi carregado
                        setTimeout(() => {
                            const camera = document.querySelector('#drone-camera');
                            const hudComponent = camera?.components?.['hud-controller'];

                            if (hudComponent) {
                                console.log('🎯 HUD Controller carregado com sucesso!');
                                console.log('📊 Configurações do HUD:', {
                                    width: hudComponent.data.hudWidth,
                                    height: hudComponent.data.hudHeight,
                                    transparency: hudComponent.data.transparency,
                                    distance: hudComponent.data.hudDistance
                                });
                            } else {
                                console.warn('⚠️ HUD Controller não foi carregado!');
                            }
                        }, 1000);

                        // Ocultar painel de ajuda do HUD após 8 segundos
                        setTimeout(() => {
                            const hudHelp = document.getElementById('hud-help');
                            if (hudHelp) {
                                hudHelp.style.opacity = '0.3';
                                hudHelp.style.transition = 'opacity 1s ease-out';
                            }
                        }, 8000);

                        // Ocultar completamente após 15 segundos
                        setTimeout(() => {
                            const hudHelp = document.getElementById('hud-help');
                            if (hudHelp) {
                                hudHelp.style.display = 'none';
                            }
                        }, 15000);
                    }, 2000);
                });
            });
        </script>
    </body>

</html>